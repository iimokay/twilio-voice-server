<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Twilio Voice Stream Player</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .status {
            margin: 20px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .connected {
            background-color: #d4edda;
            color: #155724;
        }
        .disconnected {
            background-color: #f8d7da;
            color: #721c24;
        }
        .controls {
            margin: 20px 0;
        }
        button {
            padding: 10px 20px;
            margin-right: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .play {
            background-color: #28a745;
            color: white;
        }
        .stop {
            background-color: #dc3545;
            color: white;
        }
        .wav-files {
            margin-top: 20px;
        }
        .wav-file {
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .wav-file audio {
            width: 100%;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <h1>Twilio Voice Stream Player</h1>
    <div id="status" class="status disconnected">Disconnected</div>
    <div class="controls">
        <button id="playButton" class="play">Play</button>
        <button id="stopButton" class="stop" disabled>Stop</button>
    </div>
    <div id="wavFiles" class="wav-files">
        <h2>Recorded WAV Files</h2>
    </div>

    <script>
        class AudioPlayer {
            constructor() {
                this.ws = null;
                this.audioContext = null;
                this.isPlaying = false;
                this.statusElement = document.getElementById('status');
                this.playButton = document.getElementById('playButton');
                this.stopButton = document.getElementById('stopButton');
                this.wavFilesContainer = document.getElementById('wavFiles');
                this.wavFileCount = 0;

                this.initializeEventListeners();
            }

            initializeEventListeners() {
                this.playButton.addEventListener('click', () => this.start());
                this.stopButton.addEventListener('click', () => this.stop());
            }

            async start() {
                try {
                    // 初始化 WebSocket 连接
                    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                    const wsUrl = `${protocol}//${window.location.host}/stream`;
                    this.ws = new WebSocket(wsUrl);

                    this.ws.onopen = () => {
                        this.updateStatus('Connected', true);
                        this.playButton.disabled = true;
                        this.stopButton.disabled = false;
                    };

                    this.ws.onclose = () => {
                        this.updateStatus('Disconnected', false);
                        this.playButton.disabled = false;
                        this.stopButton.disabled = true;
                        this.cleanup();
                    };

                    this.ws.onerror = (error) => {
                        console.error('WebSocket error:', error);
                        this.updateStatus('Connection error', false);
                    };

                    this.ws.onmessage = (event) => {
                        const message = JSON.parse(event.data);
                        if (message.type === 'audio') {
                            this.handleAudioData(message);
                        } else if (message.type === 'wav') {
                            this.handleWavFile(message);
                        }
                    };

                    // 初始化 AudioContext
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();

                } catch (error) {
                    console.error('Error starting audio player:', error);
                    this.updateStatus('Error starting player', false);
                }
            }

            handleAudioData(message) {
                try {
                    const audioData = this.base64ToArrayBuffer(message.data);
                    const audioBuffer = this.audioContext.createBuffer(
                        message.channels || 1,
                        audioData.length / (message.channels || 1),
                        message.sampleRate || 8000
                    );

                    // 将音频数据复制到 AudioBuffer
                    const channelData = audioBuffer.getChannelData(0);
                    for (let i = 0; i < audioData.length; i++) {
                        channelData[i] = (audioData[i] - 128) / 128.0; // 将 8 位无符号整数转换为浮点数
                    }

                    // 播放音频
                    const source = this.audioContext.createBufferSource();
                    source.buffer = audioBuffer;
                    source.connect(this.audioContext.destination);
                    source.start();
                } catch (error) {
                    console.error('Error handling audio data:', error);
                }
            }

            handleWavFile(message) {
                try {
                    const wavData = this.base64ToArrayBuffer(message.data);
                    const blob = new Blob([wavData], { type: 'audio/wav' });
                    const url = URL.createObjectURL(blob);

                    // 创建 WAV 文件元素
                    const wavFileDiv = document.createElement('div');
                    wavFileDiv.className = 'wav-file';
                    wavFileDiv.innerHTML = `
                        <h3>WAV File ${++this.wavFileCount}</h3>
                        <p>Sample Rate: ${message.sampleRate}Hz, Channels: ${message.channels}</p>
                        <audio controls src="${url}"></audio>
                        <a href="${url}" download="recording_${this.wavFileCount}.wav">Download</a>
                    `;

                    // 添加到容器
                    this.wavFilesContainer.appendChild(wavFileDiv);
                } catch (error) {
                    console.error('Error handling WAV file:', error);
                }
            }

            base64ToArrayBuffer(base64) {
                const binaryString = window.atob(base64);
                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                return bytes;
            }

            stop() {
                if (this.ws) {
                    this.ws.close();
                }
                this.cleanup();
            }

            cleanup() {
                if (this.audioContext) {
                    this.audioContext.close();
                    this.audioContext = null;
                }
                this.isPlaying = false;
            }

            updateStatus(message, isConnected) {
                this.statusElement.textContent = message;
                this.statusElement.className = `status ${isConnected ? 'connected' : 'disconnected'}`;
            }
        }

        // 创建音频播放器实例
        const player = new AudioPlayer();
    </script>
</body>
</html> 